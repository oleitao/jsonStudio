name: jsonstudio
base: core24
version: '0.1'
summary: JSON editor and viewer (Qt)
description: |
  jsonStudio is a simple JSON editor/viewer built with Qt and Python.
  It supports viewing as a tree, validation, filtering and basic styling.

grade: stable
confinement: strict

platforms:
  amd64:
    build-on: [amd64, arm64]
  arm64:
    build-on: [arm64]

apps:
  jsonstudio:
    command: bin/jsonstudio
    plugs:
      - x11
      - wayland
      - opengl
      - network
      - home
      - audio-playback
    environment:
      # Força X11 por omissão (Wayland se disponível)
      QT_QPA_PLATFORM: xcb

parts:
  jsonstudio:
    plugin: python
    source: ..
    # Se quiseres instalar libs via pip, ativa "python-packages".
    # Ex.: python-packages: [ "jsonschema" ]
    stage-packages:
      - python3
      - python3-pyqt5
      - python3-jsonschema
      - libgl1
      - libglib2.0-0
      - libx11-6
      - libxkbcommon0
      - libxext6
      - libxrender1
      - libxi6
      - libxfixes3
      - libxrandr2
      - libxinerama1
      - libxcb1
      - libxcb-keysyms1
      - libxcb-render0
      - libxcb-shape0
      - libxcb-shm0
      - libxcb-xfixes0
      - libxcb-icccm4
    override-build: |
      set -eux
      # Executa o comportamento padrão do plugin (cria venv, instala pip packages, se houver)
      craftctl default

      # Instala o launcher da app
      install -D -m 0755 /dev/stdin "$CRAFT_PART_INSTALL/bin/jsonstudio" <<'EOF'
      #!/bin/sh
      export QT_QPA_PLATFORM="${QT_QPA_PLATFORM:-xcb}"
      # Usa o Python do plugin (venv) se existir; caso contrário, usa o do sistema.
      PYBIN="$SNAP/venv/bin/python3"
      [ -x "$PYBIN" ] || PYBIN="/usr/bin/python3"
      cd "$SNAP/app"
      exec "$PYBIN" main.py "$@"
      EOF

      # Copia o código-fonte (a app está na raiz do repositório)
      mkdir -p "$CRAFT_PART_INSTALL/app"
      cp -a "$CRAFT_PART_SRC"/. "$CRAFT_PART_INSTALL/app/"

      # Garante que o .desktop e ícones entram no snap
      if [ -d "$CRAFT_PART_SRC/snap/gui" ]; then
        mkdir -p "$CRAFT_PART_INSTALL/snap/gui" "$CRAFT_PART_INSTALL/meta/gui"
        cp -a "$CRAFT_PART_SRC/snap/gui/." "$CRAFT_PART_INSTALL/snap/gui/"
        cp -a "$CRAFT_PART_SRC/snap/gui/." "$CRAFT_PART_INSTALL/meta/gui/"
      fi
